// src/commands/index.js
import { Markup } from 'telegraf';
import { setupStartCommand } from './start.command.js';
import { configurarComandosUnidades } from './unidades/index.js';
import { setupFuelCommands } from './fuel/index.js';
import { configurarComandosReportes } from './reportes/index.js';
import { setupCompanyRegisterCommands } from './registration/index.js';
import { setupTurnosCommands } from './turnos/index.js';
import { logger } from '../utils/logger.js';
import { unitController } from '../controllers/unit/index.js';

/**
 * Configurar callback global para el men√∫ principal
 */
function setupGlobalCallbacks(bot) {
  // Manejar el bot√≥n main_menu de forma global
  bot.action('main_menu', async (ctx) => {
    try {
      await ctx.answerCbQuery('Volviendo al men√∫ principal');
      
      // Limpiar el estado de conversaci√≥n
      if (ctx.session) {
        ctx.session.state = 'idle';
        ctx.session.data = {};
      }
      
      // Mostrar mensaje con men√∫ principal usando Markup directamente
      await ctx.reply('üè† Men√∫ Principal', {
        reply_markup: Markup.inlineKeyboard([
          [Markup.button.callback('üìù Registrar carga', 'register_fuel_start')],
          [Markup.button.callback('üïê Turnos', 'turnos_menu')],
          [Markup.button.callback('üëÅÔ∏è Gestionar unidades', 'manage_units')],
          [Markup.button.callback('üîç Buscar/desactivar registros', 'search_fuel_records')],
          [Markup.button.callback('üí∞ Consultar saldo pendiente', 'check_balance')],
          [Markup.button.callback('üìä Generar reporte', 'generate_report')],
          [Markup.button.callback('‚ùì Ayuda', 'show_help')]
        ])
      });
    } catch (error) {
      logger.error(`Error al volver al men√∫ principal: ${error.message}`);
      await ctx.answerCbQuery('Error al mostrar men√∫');
      
      // Intento directo con botones en l√≠nea b√°sicos
      await ctx.reply('Men√∫ Principal (alternativo)', 
        Markup.inlineKeyboard([
          [Markup.button.callback('üìù Registrar carga', 'register_fuel_start')],
          [Markup.button.callback('üïê Turnos', 'turnos_menu')],
          [Markup.button.callback('üëÅÔ∏è Unidades', 'manage_units')],
          [Markup.button.callback('üí∞ Saldo pendiente', 'check_balance')],
          [Markup.button.callback('üìä Generar reporte', 'generate_report')]
        ])
      );
    }
  });
  
  // Manejar bot√≥n de ayuda
  bot.action('show_help', async (ctx) => {
    try {
      await ctx.answerCbQuery('Mostrando ayuda');
      
      const helpMessage = `
*Instrucciones de Uso* ‚ùì

*1. Registrar una unidad:*
   ‚Ä¢ Usa el bot√≥n "Registrar unidad"
   ‚Ä¢ Ingresa el nombre del operador
   ‚Ä¢ Ingresa el n√∫mero econ√≥mico
   ‚Ä¢ Confirma los datos

*2. Registrar carga de combustible:*
   ‚Ä¢ Ve a "Ver unidades" y selecciona una unidad
   ‚Ä¢ Sigue las instrucciones para ingresar litros, monto, etc.
   ‚Ä¢ Confirma para guardar

*3. Consultar saldo pendiente:*
   ‚Ä¢ Usa el bot√≥n "Consultar saldo pendiente"

*4. Generar reportes:*
   ‚Ä¢ Usa el bot√≥n "Generar reporte"
   ‚Ä¢ Aplica los filtros deseados
   ‚Ä¢ Selecciona PDF o Excel
      `;
      
      await ctx.reply(helpMessage, {
        parse_mode: 'Markdown',
        reply_markup: Markup.inlineKeyboard([
          [Markup.button.callback('üè† Volver al men√∫ principal', 'main_menu')]
        ])
      });
    } catch (error) {
      logger.error(`Error al mostrar ayuda: ${error.message}`);
      await ctx.reply('Ocurri√≥ un error al mostrar la ayuda.');
    }
  });
  
  // Manejar bot√≥n de ver unidades
  bot.action('show_units', async (ctx) => {
    try {
      await ctx.answerCbQuery('Cargando unidades');
      
      // Llamar al controlador para mostrar unidades
      await unitController.showRegisteredUnits(ctx);
    } catch (error) {
      logger.error(`Error al mostrar unidades: ${error.message}`);
      await ctx.reply('Ocurri√≥ un error al cargar las unidades.');
      
      // Mostrar men√∫ principal como fallback
      await ctx.reply('¬øQu√© deseas hacer ahora?', {
        reply_markup: Markup.inlineKeyboard([
          [Markup.button.callback('üè† Volver al men√∫ principal', 'main_menu')]
        ])
      });
    }
  });
  
  // Manejar bot√≥n de saldo pendiente
  bot.action('check_balance', async (ctx) => {
    try {
      await ctx.answerCbQuery('Consultando saldo pendiente...');
      
      // Simular el comando /saldo
      await bot.telegram.sendMessage(ctx.chat.id, '/saldo');
    } catch (error) {
      logger.error(`Error al consultar saldo: ${error.message}`);
      await ctx.reply('Ocurri√≥ un error al consultar el saldo pendiente.');
      
      // Volver al men√∫ principal
      await ctx.reply('¬øQu√© deseas hacer ahora?', {
        reply_markup: Markup.inlineKeyboard([
          [Markup.button.callback('üè† Volver al men√∫ principal', 'main_menu')]
        ])
      });
    }
  });
  
  // Manejar bot√≥n para gestionar unidades
  bot.action('manage_units', async (ctx) => {
    try {
      await ctx.answerCbQuery();
      await ctx.reply('Selecciona una opci√≥n para gestionar las unidades:',
        Markup.inlineKeyboard([
          [Markup.button.callback('üìù Ver unidades', 'show_units')],
          [Markup.button.callback('‚ûï Registrar unidad', 'register_unit')],
          [Markup.button.callback('üöÆ Desactivar unidad', 'deactivate_unit_menu')],
          [Markup.button.callback('üè† Men√∫ principal', 'main_menu')]
        ])
      );
    } catch (error) {
      logger.error(`Error al mostrar men√∫ de gesti√≥n de unidades: ${error.message}`);
      await ctx.reply('Error al mostrar el men√∫. Por favor, intenta de nuevo m√°s tarde.',
        Markup.inlineKeyboard([
          [Markup.button.callback('üè† Men√∫ principal', 'main_menu')]
        ])
      );
    }
  });
  
  // Manejar bot√≥n de turnos
  bot.action('turnos_menu', async (ctx) => {
    try {
      await ctx.answerCbQuery('Accediendo al men√∫ de turnos');
      
      // Importar din√°micamente el controlador para evitar dependencias circulares
      const { TurnoController } = await import('../controllers/turno.controller.js');
      const turnoController = new TurnoController();
      
      await turnoController.showTurnosMenu(ctx);
    } catch (error) {
      logger.error(`Error al acceder al men√∫ de turnos: ${error.message}`);
      await ctx.answerCbQuery('Error al acceder al men√∫');
      await ctx.reply('Error al acceder al men√∫ de turnos. Por favor, intenta nuevamente.');
    }
  });
  
  // NOTA: El manejador para 'search_fuel_records' se ha movido a src/commands/fuel/desactivacion.command.js
  // para evitar duplicados y conflictos de manejadores
  
  // Manejar bot√≥n para generar reporte
  bot.action('generate_report', async (ctx) => {
    try {
      await ctx.answerCbQuery('Iniciando generaci√≥n de reporte...');
      
      // Importar din√°micamente el controlador para evitar dependencias circulares
      const { reportController } = await import('../controllers/reportes/index.js');
      
      // Llamar directamente al controlador en lugar de simular el comando
      await reportController.startReportGeneration(ctx);
      
      logger.info('Generador de reportes iniciado directamente desde el bot√≥n');
    } catch (error) {
      logger.error(`Error al iniciar reporte: ${error.message}`);
      await ctx.reply('Ocurri√≥ un error al iniciar la generaci√≥n del reporte.');
      
      // Volver al men√∫ principal
      await ctx.reply('¬øQu√© deseas hacer ahora?', {
        reply_markup: Markup.inlineKeyboard([
          [Markup.button.callback('üè† Volver al men√∫ principal', 'main_menu')]
        ])
      });
    }
  });
}

/**
 * Registra todos los comandos del bot
 * @param {Telegraf} bot - Instancia del bot de Telegram
 */
export function registerCommands(bot) {
  try {
    logger.info('Iniciando registro de comandos');
    
    // Registrar comandos principales
    logger.info('Configurando comando start');
    setupStartCommand(bot);
    
    logger.info('Configurando sistema de unidades');
    configurarComandosUnidades(bot);
    
    logger.info('Configurando comandos de combustible');
    setupFuelCommands(bot);
    
    logger.info('Configurando sistema de reportes');
    configurarComandosReportes(bot);
    
    logger.info('Configurando sistema de registro de empresas');
    setupCompanyRegisterCommands(bot);
    
    logger.info('Configurando sistema de turnos');
    setupTurnosCommands(bot);
    
    // Configurar callbacks globales
    setupGlobalCallbacks(bot);
    
    // Definir comandos para usuarios registrados (con tenant)
    const registeredUserCommands = [
      { command: 'start', description: 'Iniciar el bot' },
      { command: 'registrar', description: 'Registrar una nueva unidad' },
      { command: 'turnos', description: 'Gestionar turnos de trabajo' },
      { command: 'saldo', description: 'Ver saldo pendiente total' },
      { command: 'reporte', description: 'Generar reportes de cargas' },
      { command: 'ayuda', description: 'Ver instrucciones de uso' }
    ];
    
    // Definir comandos para usuarios no registrados (sin tenant)
    const unregisteredUserCommands = [
      { command: 'start', description: 'Iniciar el bot' },
      { command: 'registrar_empresa', description: 'Solicitar registro de empresa' },
      { command: 'vincular', description: 'Vincular grupo con token de empresa' }
    ];
    
    // Establecer comandos en la interfaz de Telegram seg√∫n el √°mbito
    logger.info('Registrando comandos en API de Telegram para diferentes √°mbitos');
    
    // 1. Comandos para chats privados (usuarios no registrados) - limitado a registro
    bot.telegram.setMyCommands(unregisteredUserCommands, { scope: { type: 'all_private_chats' } });
    logger.info('Comandos para chats privados registrados');
    
    // 2. Comandos para grupos (usuarios registrados) - men√∫ completo
    bot.telegram.setMyCommands(registeredUserCommands, { scope: { type: 'all_group_chats' } });
    logger.info('Comandos para grupos registrados');
    
    // Implementar comando /ayuda
    bot.command('ayuda', async (ctx) => {
      try {
        logger.info(`Usuario ${ctx.from?.id} solicit√≥ ayuda via comando`);
        
        const helpMessage = `
*Instrucciones de Uso* ‚ùì

*1. Registrar una unidad:*
   ‚Ä¢ Usa el bot√≥n "Registrar unidad"
   ‚Ä¢ Ingresa el nombre del operador
   ‚Ä¢ Ingresa el n√∫mero econ√≥mico
   ‚Ä¢ Confirma los datos

*2. Registrar carga de combustible:*
   ‚Ä¢ Ve a "Ver unidades" y selecciona una unidad
   ‚Ä¢ Sigue las instrucciones para ingresar litros, monto, etc.
   ‚Ä¢ Confirma para guardar

*3. Consultar saldo pendiente:*
   ‚Ä¢ Usa el bot√≥n "Consultar saldo pendiente"

*4. Generar reportes:*
   ‚Ä¢ Usa el bot√≥n "Generar reporte"
   ‚Ä¢ Aplica los filtros deseados
   ‚Ä¢ Selecciona PDF o Excel
        `;
        
        await ctx.reply(helpMessage, {
          parse_mode: 'Markdown',
          reply_markup: Markup.inlineKeyboard([
            [Markup.button.callback('üè† Volver al men√∫ principal', 'main_menu')]
          ])
        });
      } catch (error) {
        logger.error(`Error al mostrar ayuda por comando: ${error.message}`);
        await ctx.reply('Ocurri√≥ un error al mostrar la ayuda.');
      }
    });
    
    // A√±adir manejador para comandos no registrados
    bot.on('text', (ctx, next) => {
      logger.info(`Recibido texto: ${ctx.message.text}`);
      return next();
    });
    
    logger.info('Comandos registrados correctamente');
  } catch (error) {
    logger.error('Error al registrar comandos:', error);
    throw error;
  }
}